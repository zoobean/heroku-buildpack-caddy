# Test Caddyfile for Ruby/Rack app with Caddy WAF
# Used for testing the heroku-buildpack-caddy
{
	# debug
	auto_https off
	servers {
		trusted_proxies static 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22 15.223.41.195/32
		trusted_proxies_strict
		protocols h1
	}
	log default {
		output stdout
		format console {
			time_format iso8601
		}
		level WARN
	}
}

:{$PORT} {
	# Set up trusted proxies for Cloudflare and local networks

	# WAF Configuration with default settings
	route {
		waf {
			# Basic WAF configuration
			rule_file config/caddy/rules.json
			# ip_blacklist_file config/caddy/ip_blacklist.txt
			# dns_blacklist_file config/caddy/dns_blacklist.txt

			# Metrics endpoint (protected by basic auth below)
			metrics_endpoint /waf_metrics

			# Rate limiting
			# rate_limit {
			# 	window 1m
			# 	max_requests 100
			# }

			# Enable country blocking (requires GeoLite2 database)
			# country_blocking {
			#     allowed_countries ["US", "CA", "GB"]
			#     block_tor_exit_nodes true
			# }
			anomaly_threshold 100
		}
		@wafmetrics path /waf_metrics
		handle @wafmetrics {
			basic_auth {
				admin {$WAF_ADMIN_PASS_HASH}
			}
		}

		handle {
			reverse_proxy localhost:{$RUBY_PORT} {
				header_up Host {host}
				header_up X-Real-IP {remote}
				header_up X-Forwarded-Port {server_port}
				header_up X-Forwarded-Proto "https"
			}
		}
	}

	# Handle Rails assets with caching
	route /assets/* {
		# Cache responses from Rails for 1 year
		cache {
			ttl 1y
			simplefs {
				configuration {
					size 10000
					path /tmp/caddy_cache
					directory_size 100MB
				}
			}
		}

		# Set cache headers for browsers/CDNs
		header Cache-Control "public, max-age=31536000, immutable"
		header Expires "Thu, 31 Dec 2025 23:55:55 GMT"

		# Always proxy to Ruby/Rack app for assets
		reverse_proxy localhost:{$RUBY_PORT} {
			header_up Host {host}
			header_up X-Real-IP {remote}
			header_up X-Forwarded-Port {server_port}
			header_up X-Forwarded-Proto "https"
		}
	}

	# Serve robots.txt, favicon.ico, etc. directly
	# route {
	# 	@static_files path /robots.txt /favicon.ico /apple-touch-icon* /android-chrome* /site.webmanifest
	# 	handle @static_files {
	# 		root * public
	# 		file_server
	# 	}
	# }

	# Fallback to Ruby/Rack app for everything else
	reverse_proxy localhost:{$RUBY_PORT} {
		header_up Host {host}
		header_up X-Real-IP {remote}
		header_up X-Forwarded-Port {server_port}
		header_up X-Forwarded-Proto "https"
	}

	# Security headers
	header {
		# Remove server information
		# -Server

		# Security headers
		# X-Content-Type-Options nosniff
		# X-Frame-Options DENY
		# X-XSS-Protection "1; mode=block"
		# Referrer-Policy strict-origin-when-cross-origin

		# HSTS (uncomment for HTTPS)
		# Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	}

	# Logging to stdout (Heroku requirement)
	log {
		output stdout
		format console {
			time_format iso8601
		}
		level WARN
	}

	# Error handling
	handle_errors {
		@404 expression `{err.status_code} == 404`
		handle @404 {
			root * public
			try_files /404.html
			file_server
		}

		@500 expression `{err.status_code} >= 500`
		handle @500 {
			root * public
			try_files /500.html
			file_server
		}
	}
}
